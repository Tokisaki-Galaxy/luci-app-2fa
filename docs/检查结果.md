# 2FA 插件行为检查结果

## 问题回答

### 问题 1: 如果这个插件启用的时候,密钥设置为空,登录界面会怎么样?会不会无法登录

**回答**: ❌ **不会无法登录**。用户依然可以正常登录,只需要输入密码即可。

#### 详细说明

当 2FA 插件在全局启用,但用户的密钥为空时,系统会**自动跳过 2FA 验证**。

**代码证据** (来自 `luci-app-2fa/root/usr/share/luci/auth.d/2fa.uc`):

```javascript
// 第 356-377 行: is_2fa_enabled() 函数
function is_2fa_enabled(username) {
  let uci = require("uci");
  let ctx = uci.cursor();

  // 检查 2FA 是否全局启用
  let enabled = ctx.get("2fa", "settings", "enabled");
  if (enabled != "1") return false;

  // 清理用户名
  let safe_username = sanitize_username(username);
  if (!safe_username) return false;

  // 检查用户是否配置了密钥
  let key = ctx.get("2fa", safe_username, "key");
  if (!key || key == "") return false; // ← 如果密钥为空,返回 false!

  return true;
}
```

**登录流程**:

1. 用户输入用户名和密码
2. 密码验证后,调用 `check()` 函数 (第 506 行)
3. `check()` 调用 `is_2fa_enabled(user)` (第 528 行)
4. 如果密钥为空,`is_2fa_enabled()` 返回 `false`
5. `check()` 返回 `{ required: false }` - **不需要 2FA**
6. 用户只需密码即可登录,不会显示 OTP 输入框

**行为总结**:

| 全局 2FA 设置 | 用户密钥   | 行为                          |
| ------------- | ---------- | ----------------------------- |
| 启用          | 有有效密钥 | 需要 2FA,显示 OTP 输入框      |
| 启用          | 空或缺失   | **跳过 2FA**,仅需密码即可登录 |
| 禁用          | 任意       | 跳过 2FA,仅需密码即可登录     |

**安全设计**: 这是一个**安全特性**,用于防止锁定场景:

- 如果你不小心启用了全局 2FA 但还没有设置密钥
- 如果你丢失了访问认证器应用的权限
- 你仍然可以登录并重新配置

---

### 问题 2: 如果 root 启用,但是切换到另一个用户登录,他们两个是共享一个 TOTP 密钥吗?

**回答**: ❌ **不共享**。每个用户都有自己独立的 TOTP 密钥。

#### 详细说明

每个用户都有**独立的 UCI 配置节**,拥有自己的个人密钥。密钥**不会**在用户之间共享。

**代码证据**:

**UCI 配置结构** (来自 `luci-app-2fa/root/etc/config/2fa`):

```
config settings 'settings'
    option enabled '0'
    ...

config login 'root'          ← 'root' 用户的独立配置节
    option key ''
    option type 'totp'
    option step '30'
    option counter '0'

# 如果添加另一个用户,配置会是:
# config login 'admin'       ← 'admin' 用户的独立配置节
#     option key 'DIFFERENTKEY'
#     option type 'totp'
#     ...
```

**密钥获取方式** (来自 `auth.d/2fa.uc` 第 372 行):

```javascript
// 用户名被用作 UCI 配置节名称
let key = ctx.get("2fa", safe_username, "key");
//                         ^^^^^^^^^^^^
//                         配置节名称 = 用户名
```

例如:

- Root 用户密钥: `uci get 2fa.root.key`
- Admin 用户密钥: `uci get 2fa.admin.key`
- 其他用户密钥: `uci get 2fa.username.key`

**多用户示例**:

```bash
# 配置 root 用户
uci set 2fa.root.key='JBSWY3DPEHPK3PXP'
uci set 2fa.root.type='totp'

# 配置 admin 用户,使用不同的密钥
uci set 2fa.admin=login
uci set 2fa.admin.key='GEZDGNBVGY3TQOJQ'  # 不同的密钥!
uci set 2fa.admin.type='totp'

uci commit 2fa
```

**行为总结**:

| 用户  | 密钥存储位置    | TOTP 代码           |
| ----- | --------------- | ------------------- |
| root  | `2fa.root.key`  | 由 root 的密钥生成  |
| admin | `2fa.admin.key` | 由 admin 的密钥生成 |
| user1 | `2fa.user1.key` | 由 user1 的密钥生成 |

**每个用户必须**:

1. 生成自己的秘密密钥
2. 使用认证器应用扫描自己的二维码
3. 登录时使用自己的 TOTP 代码

**独立配置**:

- 你可以为某些用户启用 2FA,而不为其他用户启用
- 每个用户可以独立选择 TOTP 或 HOTP
- 每个用户可以有不同的时间步长设置

---

## 安全影响

### 空密钥安全性

空密钥跳过是有意设计的,并且是安全的,因为:

1. 用户仍需有效密码才能登录
2. 防止 2FA 配置错误导致完全锁定
3. 管理员可以登录以正确修复/配置 2FA

### 用户隔离的好处

每个用户拥有独立密钥提供:

1. **个人责任**: 每个用户的 2FA 独立
2. **安全隔离**: 攻陷一个用户的认证器不会影响其他用户
3. **灵活部署**: 可以逐用户逐步推出 2FA
4. **轻松密钥轮换**: 可以更改一个用户的密钥而不影响其他用户

---

## 测试

已创建自动化测试来验证两种行为:

1. **tests/e2e/empty-key-behavior.spec.ts**: 测试空密钥时的登录
2. **tests/e2e/user-specific-keys.spec.ts**: 测试用户特定的密钥存储

运行测试:

```bash
npm test
```

---

## 建议

### 给系统管理员:

1. **逐步启用 2FA**:
   - 首先为自己设置密钥
   - 彻底测试登录
   - 然后为其他用户启用

2. **始终保留备用管理员账户**:
   - 保留一个没有启用 2FA 的账户
   - 或保留备份恢复代码
   - 以防认证器丢失

3. **为 LAN 使用 IP 白名单**:
   - 将你的 LAN 子网添加到 IP 白名单
   - 从可信网络跳过 2FA
   - WAN 访问完全 2FA 保护

### 给用户:

1. 启用 2FA 后**立即生成并保存密钥**
2. 在登出之前**测试 OTP 登录**
3. **安全保存备份代码**或二维码
4. **每个用户需要自己的认证器应用条目** - 不要尝试共享!

---

## 代码引用

| 行为         | 文件                  | 行数    | 函数               |
| ------------ | --------------------- | ------- | ------------------ |
| 空密钥跳过   | `auth.d/2fa.uc`       | 356-377 | `is_2fa_enabled()` |
| 用户特定密钥 | `auth.d/2fa.uc`       | 372     | 密钥获取           |
| UCI 配置结构 | `root/etc/config/2fa` | 13-17   | 默认配置           |
| RPC 后端     | `rpcd/ucode/2fa.uc`   | 381-456 | `isEnabled` 方法   |

---

## 总结

✅ **问题 1**: 空密钥 = **允许正常登录** (安全地跳过 2FA)  
✅ **问题 2**: 每个用户 = **独立的 TOTP 密钥** (不共享)

这两种行为都是**有意设计**的,提供了良好的安全性和用户友好的安全特性。

---

## 完整文档

详细的英文文档请参见: [docs/BEHAVIOR_ANALYSIS.md](./BEHAVIOR_ANALYSIS.md)
